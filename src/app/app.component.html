<!-- Header -->
<header class="bg-white shadow-sm py-3">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-2 text-center">
        <img src="assets/flag-senegal.webp" alt="Logo CSU" height="60">
      </div>
      <div class="col-md-8 text-center">
        <h1 class="h4 mb-1 text-primary">COUVERTURE SANITAIRE UNIVERSELLE</h1>
        <p class="mb-0 text-muted"><small>République du Sénégal</small></p>
      </div>
      <div class="col-md-2 text-center">
        <img src="assets/flag-senegal.webp" alt="Drapeau Sénégal" height="40">
      </div>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="py-4">
  <div class="container">
    
    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
      <h3 class="mt-3">Chargement...</h3>
    </div>

    <!-- Error State -->
    <div *ngIf="error" class="alert alert-danger text-center">
      <h4><i class="fas fa-exclamation-triangle"></i> Erreur</h4>
      <p>{{ errorMessage }}</p>
     <button class="btn btn-outline-danger" (click)="reloadPage()">
        Réessayer
      </button>
    </div>

    <!-- Welcome Page (no code) -->
    <div *ngIf="!loading && !error && !beneficiaire" class="text-center py-5">
      <div class="card shadow">
        <div class="card-body p-5">
          <i class="fas fa-qr-code display-1 text-primary mb-4"></i>
          <h2 class="mb-3">Vérification Carte Bénéficiaire</h2>
          <p class="text-muted mb-4">
            Scannez un QR code de carte CSU pour vérifier sa validité
          </p>
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            Cette page s'ouvre automatiquement lorsqu'un QR code est scanné
          </div>
        </div>
      </div>
    </div>

    <!-- Beneficiary Card -->
    <div *ngIf="!loading && !error && beneficiaire" class="card shadow-lg">
      
      <!-- Card Header -->
      <div class="card-header" [ngClass]="{'bg-success': isCardValid(), 'bg-danger': !isCardValid()}">
        <div class="row align-items-center">
          <div class="col-md-8 text-white">
            <h3 class="mb-1">
              <i class="fas" [ngClass]="{'fa-check-circle': isCardValid(), 'fa-times-circle': !isCardValid()}"></i>
              {{ isCardValid() ? 'CARTE VALIDE' : 'CARTE EXPIRÉE' }}
            </h3>
            <small>Vérifié le {{ today | date:'dd/MM/yyyy à HH:mm' }}</small>
          </div>
          <div class="col-md-4 text-end">
            <button class="btn btn-light btn-sm me-2" (click)="printPage()">
              <i class="fas fa-print"></i> Imprimer
            </button>
            <button class="btn btn-light btn-sm" (click)="sharePage()">
              <i class="fas fa-share-alt"></i> Partager
            </button>
          </div>
        </div>
      </div>

      <!-- Card Body -->
      <div class="card-body p-4">
        
        <!-- Identity Section -->
        <div class="row mb-4">
          <div class="col-md-3 text-center">
            <!-- Photo -->
            <div class="mb-3">
              <div class="rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto"
                   style="width: 120px; height: 120px;">
                <i class="fas fa-user fs-1 text-muted"></i>
              </div>
            </div>
            
            <!-- Matricule -->
            <div class="mb-3">
              <span class="badge bg-primary fs-6 p-2">
                {{ beneficiaire.codeImmatriculation }}
              </span>
            </div>
            
            <!-- QR Code -->
            <!-- <div class="mt-4">
              <img *ngIf="qrCodeUrl" [src]="qrCodeUrl" alt="QR Code" class="img-fluid" style="max-width: 120px;">
              <small class="text-muted d-block mt-2">Scannez pour sauvegarder</small>
            </div> -->
          </div>

          <div class="col-md-9">
            <h2 class="mb-3">
              {{ beneficiaire.prenom }} {{ beneficiaire.nom }}
              <small class="text-muted">({{ getAge() }} ans)</small>
            </h2>
            
            <div class="row">
              <div class="col-md-6">
                <p><strong>Sexe:</strong> {{ beneficiaire.sexe }}</p>
                <p><strong>Téléphone:</strong> {{ beneficiaire.telephone }}</p>
                <p><strong>CNI:</strong> {{ beneficiaire.numeroPiece || 'N/A' }}</p>
              </div>
              <div class="col-md-6">
                <p><strong>Date naissance:</strong> {{ formatDate(beneficiaire.dateNaissance) }}</p>
                <p><strong>Lieu naissance:</strong> {{ beneficiaire.lieuNaissance || 'N/A' }}</p>
                <p><strong>Statut:</strong> 
                  <span class="badge" [ngClass]="{
                    'bg-success': beneficiaire.etat === 'ACTIVE',
                    'bg-warning': beneficiaire.etat === 'SUSPENDRE',
                    'bg-danger': beneficiaire.etat === 'BLOQUER'
                  }">
                    {{ beneficiaire.etat }}
                  </span>
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Address Section -->
        <div class="row mb-4">
          <div class="col-12">
            <h4 class="border-bottom pb-2">
              <i class="fas fa-home text-primary me-2"></i>Adresse
            </h4>
            <div class="row">
              <div class="col-md-4">
                <p><strong>Adresse:</strong><br>{{ beneficiaire.adresse || 'N/A' }}</p>
              </div>
              <div class="col-md-4">
                <p><strong>Région:</strong><br>{{ beneficiaire.region || 'N/A' }}</p>
              </div>
              <div class="col-md-4">
                <p><strong>Département:</strong><br>{{ beneficiaire.departement || 'N/A' }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Affiliation Section -->
        <div class="row mb-4">
          <div class="col-12">
            <h4 class="border-bottom pb-2">
              <i class="fas fa-users text-primary me-2"></i>Informations d'affiliation
            </h4>
            <div class="row">
              <div class="col-md-3">
                <p><strong>Régime:</strong><br>Contributif</p>
              </div>
              <div class="col-md-3">
                <p><strong>Assureur:</strong><br>{{ beneficiaire.assureur || 'SEN-CSU' }}</p>
              </div>
              <div class="col-md-3">
                <p><strong>Type adhésion:</strong><br>{{ beneficiaire.typeAdhesion || 'Groupe' }}</p>
              </div>
              <div class="col-md-3">
                <p><strong>Groupe:</strong><br>{{ beneficiaire.groupe || 'SONATEL' }}</p>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-4">
                <p><strong>Type bénéficiaire:</strong><br>{{ beneficiaire.typeBeneficiaire || 'Classique' }}</p>
              </div>
              <div class="col-md-4">
                <p><strong>Type cotisation:</strong><br>{{ beneficiaire.typeCotisation || 'Annuelle' }}</p>
              </div>
              <div class="col-md-4">
               <p><strong>Date enregistrement:</strong><br>{{ beneficiaire.dateInsert ? formatDate(beneficiaire.dateInsert) : 'N/A' }}</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Coverage Period -->
        <div class="row">
          <div class="col-12">
            <h4 class="border-bottom pb-2">
              <i class="fas fa-calendar-check text-primary me-2"></i>Période de couverture
            </h4>
            <div class="row align-items-center">
              <div class="col-md-4">
               <p><strong>Date début:</strong><br>{{ beneficiaire.dateDebutc ? formatDate(beneficiaire.dateDebutc) : 'N/A' }}</p>
              </div>
              <div class="col-md-4">
               <p><strong>Date fin:</strong><br>{{ beneficiaire.dateFinc ? formatDate(beneficiaire.dateFinc) : 'N/A' }}</p>
              </div>
              <div class="col-md-4 text-center">
                <!-- Empty for alignment -->
              </div>
            </div>
            
            <!-- Progress Bar -->
            <div class="mt-3">
              <div class="progress" style="height: 25px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated"
                     [ngClass]="{'bg-success': isCardValid(), 'bg-danger': !isCardValid()}"
                     [style.width]="getProgress() + '%'">
                  {{ getProgress().toFixed(1) }}%
                </div>
              </div>
              <div class="d-flex justify-content-between mt-2">
               <small>{{ beneficiaire.dateDebutc ? formatDate(beneficiaire.dateDebutc) : 'N/A' }}</small>
                <small>{{ beneficiaire.dateFinc ? formatDate(beneficiaire.dateFinc) : 'N/A' }}</small>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</main>

<!-- Footer -->
<footer class="bg-dark text-white py-4 mt-4">
  <div class="container">
    <div class="row">
      <div class="col-md-4">
        <h6>COUVERTURE SANITAIRE UNIVERSELLE</h6>
        <small>République du Sénégal</small>
      </div>
      <div class="col-md-4 text-center">
        <small>© {{ today.getFullYear() }} CSU Sénégal</small><br>
        <small class="text-muted">Version 1.0</small>
      </div>
      <div class="col-md-4 text-end">
        <small>
          <i class="fas fa-phone me-1"></i> 33 800 00 00<br>
          <i class="fas fa-envelope me-1"></i> contact@csu.sn
        </small>
      </div>
    </div>
  </div>
</footer>